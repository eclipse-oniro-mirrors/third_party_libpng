From 01d0d50a1ab008a766fd38204ef9eeb5d7ecff52 Mon Sep 17 00:00:00 2001
From: guokuan <guokuan1@huawei.com>
Date: Mon, 19 Jan 2026 16:56:43 +0800
Subject: [PATCH] =?UTF-8?q?[Backport]=20png=5Fimage=5Fread=5Fdirect=5Fscal?=
CVE:CVE-2026-22695
Reference:https://github.com/pnggroup/libpng/issues/778
---
 pngread.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/pngread.c b/pngread.c
index 7717d57..820533f 100644
--- a/pngread.c
+++ b/pngread.c
@@ -3268,9 +3268,11 @@ png_image_read_direct_scaled(png_voidp argument)
        argument);
    png_imagep image = display->image;
    png_structrp png_ptr = image->opaque->png_ptr;
+   png_inforp info_ptr = image->opaque->info_ptr;
    png_bytep local_row = png_voidcast(png_bytep, display->local_row);
    png_bytep first_row = png_voidcast(png_bytep, display->first_row);
    ptrdiff_t row_bytes = display->row_bytes;
+   size_t copy_bytes = png_get_rowbytes(png_ptr, info_ptr);
    int passes;
 
    /* Handle interlacing. */
@@ -3300,7 +3302,7 @@ png_image_read_direct_scaled(png_voidp argument)
          png_read_row(png_ptr, local_row, NULL);
 
          /* Copy from local_row to user buffer. */
-         memcpy(output_row, local_row, (size_t)row_bytes);
+         memcpy(output_row, local_row, copy_bytes);
          output_row += row_bytes;
       }
    }
-- 
2.1.4

